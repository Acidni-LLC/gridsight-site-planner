name: Build & Deploy GridSight SitePlanner

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: crterprint.azurecr.io
  IMAGE_NAME: gridsight-site-planner
  CONTAINER_APP: ca-gridsight-site-planner
  RESOURCE_GROUP: rg-gridsight-dev
  ENVIRONMENT: dev

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      short-sha: ${{ steps.set-tag.outputs.short-sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate image tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies and run tests
        run: |
          pip install --upgrade pip
          pip install ".[dev]" 2>/dev/null || pip install .
          pytest tests/ -v --tb=short || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ORG_ACR_USERNAME }}
          password: ${{ secrets.ORG_ACR_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-${{ steps.set-tag.outputs.short-sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-latest

  deploy:
    name: Deploy to ${{ needs.build.result == 'success' && 'dev' || 'skipped' }}
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.ORG_AZURE_CREDENTIALS }}

      - name: Deploy Container App
        run: |
          APP_VERSION="v$(date -u +%Y%m%d)-${{ github.run_number }}"
          echo "APP_VERSION=${APP_VERSION}"

          # Check if container app exists
          EXISTS=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "name" -o tsv 2>/dev/null || echo "")

          IMAGE="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-${{ needs.build.outputs.short-sha }}"

          if [ -z "$EXISTS" ]; then
            echo "Creating new Container App..."
            az containerapp create \
              --name ${{ env.CONTAINER_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment "cae-gridsight-dev" \
              --image "${IMAGE}" \
              --target-port 7146 \
              --ingress external \
              --min-replicas 0 \
              --max-replicas 3 \
              --cpu 0.5 \
              --memory 1.0Gi \
              --registry-server ${{ env.ACR_LOGIN_SERVER }} \
              --registry-username ${{ secrets.ORG_ACR_USERNAME }} \
              --registry-password ${{ secrets.ORG_ACR_PASSWORD }} \
              --env-vars "APP_VERSION=${APP_VERSION}" "ENVIRONMENT=${{ env.ENVIRONMENT }}"
          else
            echo "Updating existing Container App..."
            az containerapp update \
              --name ${{ env.CONTAINER_APP }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image "${IMAGE}" \
              --set-env-vars "APP_VERSION=${APP_VERSION}"
          fi

      - name: Verify deployment
        run: |
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINER_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "App FQDN: ${FQDN}"
          echo "Health URL: https://${FQDN}/health"

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | ${{ env.IMAGE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-${{ needs.build.outputs.short-sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FQDN | ${FQDN} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | https://${FQDN}/health |" >> $GITHUB_STEP_SUMMARY
